{% extends "base.html" %}
{% block content %}
      <h1>All night DJ </h1>
      {%if playlists%}

      <script>
      function getTimeRemaining(endtime, actualDate){
        console.log("getTimeRemaining::Entering function")
        var date = Date.parse(new Date());
        console.log("DATE : " + actualDate);
        console.log("Endtime : " + endtime);
      var t = endtime - actualDate;
      console.log("T : " + t);
        console.log("getTimeRemaining::t=" + parseInt(t));
      var seconds = Math.floor( (t/1000) % 60 );
      console.log("getTimeRemaining::seconds=" + parseInt(seconds));
      var minutes = Math.floor( (t/1000/60) % 60 );
      console.log("getTimeRemaining::minutes=" + parseInt(minutes));
      return {
        'total': t,
        'minutes': minutes,
        'seconds': seconds
        };
      }

      function initializeClock(id, endtime) {
        var playlistToPlay = 0;
        console.log('initializeClock::endtime=' + endtime);
      var clock = document.getElementById(id);
      var timeinterval = setInterval(function(){
      var t = getTimeRemaining(endtime, Date.parse(new Date()));
      clock.innerHTML = 'days: ' + t.days + '<br>' +
                        'hours: '+ t.hours + '<br>' +
                        'minutes: ' + t.minutes + '<br>' +
                        'seconds: ' + t.seconds;
        if(t.total<=0){
          console.log("TEMPS ECOULE !!!")
          clearInterval(timeinterval);
          playlistToPlay += 2;
          changePlaylist(playlistToPlay);
        }
      },1000);
    }

    function changePlaylist(playlistToPlay) {
      console.log("****++++++------+++++****")
      var size = {{size}};
      var pl = {{playlists|tojson}};

      var duration = pl[playlistToPlay+1] * 1000;

      console.log("ChangePlaylist::Given duration in milliseconds : "  + duration);
      var endtime = Date.parse(new Date()) + parseInt(duration);
      console.log("ChangePlaylist::Given endtime : " + endtime);

      initializeClock('clockdiv', endtime);

      if(document.getElementById("player") !== null)
      {
        element = document.getElementById("player");
        element.parentNode.removeChild(element);
      }
        var url="https://www.deezer.com/plugins/player"
        + "?format=classic&autoplay=true"
        + "&playlist=true&width=700&height=350"
        + "&color=007FEB&layout=dark&size=medium"
        + "&type=playlist&app_id=175951&id="
        + pl[playlistToPlay];

        var iframe =  '<iframe id =\"player\" scrolling=\"no\" '
                        +'frameborder=\"0\" '
                        +'allowTransparency="true" '
                        + 'src=' + url
                        + ' width=\"700\" '
                        + 'height=\"350\">'
                        +'</iframe>\n';


        document.write(iframe);

      }

    function main() {
      document.write('<div id="clockdiv"></div>');
      changePlaylist(0);
      document.write('<input type=\"button\" onclick=\"location.href = \'/user\'\" value=\"Retour\"/>');
    }

      window.onload = main();
      </script>

      {%endif%}
{% endblock %}
